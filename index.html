<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Match Line System with Append & Count</title>
<style>
  body {
    margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #111; color: #eee; min-height: 100vh; display: flex; align-items: center; justify-content: center;
    padding: 15px;
  }
  .container {
    max-width: 600px; width: 100%;
    background: #1a1a1a; border-radius: 12px;
    padding: 20px 25px; box-shadow: 0 0 30px #00ffccaa;
    display: flex;
    flex-direction: column;
  }
  h2 {
    text-align: center; color: #00ffcc; margin-bottom: 25px;
  }
  input, textarea, button, select {
    width: 100%; margin-bottom: 15px; border-radius: 8px;
    border: none; padding: 10px 12px; font-size: 16px;
    box-sizing: border-box;
    background: #222; color: #eee;
    transition: background 0.3s ease;
  }
  input:focus, textarea:focus, select:focus {
    outline: none;
    background: #333;
  }
  button {
    background: #00ffcc; color: #000; font-weight: 700;
    cursor: pointer; transition: background 0.3s ease;
  }
  button:hover:not(:disabled) {
    background: #00ccaaff;
  }
  button:disabled {
    background: #004d4d;
    cursor: not-allowed;
  }
  .tabs {
    display: flex; margin-bottom: 30px;
  }
  .tabs button {
    flex: 1; padding: 12px 0; background: #222;
    color: #eee; font-weight: 600; border-radius: 0;
    border-bottom: 3px solid transparent; cursor: pointer;
    transition: background 0.3s ease, border-color 0.3s ease;
  }
  .tabs button.active {
    background: #000;
    border-color: #00ffcc;
  }
  .hidden {
    display: none !important;
  }
  #saveProgress {
    font-weight: 600;
    margin-bottom: 15px;
    color: #0ff;
    min-height: 22px;
  }
  #linesCount {
    color: #0ff; font-weight: 600; margin-bottom: 10px;
  }
  #resultPre {
    background:#222; border-radius:8px; padding:15px; height: 200px; overflow-y:auto; white-space: pre-wrap; margin-top:15px;
  }
  .copy-btn {
    background: #00cc99; border: none; color: #000; padding: 8px 16px;
    border-radius: 5px; cursor: pointer; font-weight: 600;
    font-size: 16px;
    user-select: none;
    margin-bottom: 15px;
  }
  #adminButtonsRow {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
  }
  #adminButtonsRow button {
    flex: 1;
  }
  label.file-label {
    display: block;
    background: #008080aa;
    color: white;
    font-weight: 700;
    text-align: center;
    padding: 12px;
    border-radius: 8px;
    cursor: pointer;
    margin-bottom: 15px;
  }
  input[type="file"] {
    display: none;
  }
  #loginStatus {
    color: #f44; font-weight: 600; margin-bottom: 15px;
    min-height: 22px;
  }
  #adminInfo {
    color: #0f0; font-weight: 600; margin-bottom: 15px;
  }
  #logoutBtn {
    background: #f44 !important;
    margin-bottom: 15px;
  }
</style>
</head>
<body>

<div class="container">
  <h2>üîê Match Line System with Append & Count</h2>

  <div class="tabs">
    <button id="tabAdmin">Admin</button>
    <button id="tabUser" class="active">User</button>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel" class="hidden">
    <div id="loginSection">
      <input type="email" id="adminEmail" placeholder="Admin Email" autocomplete="off" />
      <input type="password" id="adminPassword" placeholder="Password" autocomplete="off" />
      <button id="loginBtn">Login</button>
      <p id="loginStatus"></p>
    </div>

    <div id="adminControls" class="hidden">
      <p id="adminInfo">Logged in as Admin</p>
      <button id="logoutBtn">Logout</button>

      <input type="date" id="adminDate" />
      <p id="linesCount">Lines saved: 0</p>

      <div id="adminButtonsRow">
        <button id="adminSaveBtn">Save Lines (Append)</button>
        <button id="adminDeleteBtn" style="background:#f44; color:#fff;">Delete Date Data</button>
      </div>

      <textarea id="adminLines" rows="8" placeholder="Paste new lines here to append (one per line)"></textarea>

      <label for="fileInput" class="file-label">üìÇ Import lines from file (.txt)</label>
      <input type="file" id="fileInput" accept=".txt" />

      <p id="saveProgress"></p>
    </div>
  </div>

  <!-- User Panel -->
  <div id="userPanel">
    <input type="date" id="userDate" />

    <label for="userFileInput" class="file-label">üìÇ Import lines from file (.txt)</label>
    <input type="file" id="userFileInput" accept=".txt" />

    <textarea id="userLines" rows="6" placeholder="Enter your lines (one per line)"></textarea>
    <button id="userMatchBtn">Show Results</button>

    <pre id="resultPre"></pre>

    <button id="copyAllBtn" class="copy-btn hidden">Copy All Matched Lines</button>
    <button id="exportBtn" class="copy-btn hidden">Export Matched to Excel</button>
    <button id="printBtn" class="copy-btn hidden">Print Matched Results</button>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- SheetJS for Excel export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCasjbGx7JBgbnZbGLkMx0RDb3OFRR4I_o",
    authDomain: "matchlineapp.firebaseapp.com",
    projectId: "matchlineapp",
    storageBucket: "matchlineapp.firebasestorage.app",
    messagingSenderId: "1053732074460",
    appId: "1:1053732074460:web:cde960ac63d4bd32151519"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // UI Elements
  const tabAdmin = document.getElementById('tabAdmin');
  const tabUser = document.getElementById('tabUser');
  const adminPanel = document.getElementById('adminPanel');
  const userPanel = document.getElementById('userPanel');

  const loginSection = document.getElementById('loginSection');
  const adminControls = document.getElementById('adminControls');
  const adminEmailInput = document.getElementById('adminEmail');
  const adminPasswordInput = document.getElementById('adminPassword');
  const loginBtn = document.getElementById('loginBtn');
  const loginStatus = document.getElementById('loginStatus');
  const logoutBtn = document.getElementById('logoutBtn');
  const adminInfo = document.getElementById('adminInfo');

  const adminDateInput = document.getElementById('adminDate');
  const adminLinesTextarea = document.getElementById('adminLines');
  const fileInput = document.getElementById('fileInput');
  const adminSaveBtn = document.getElementById('adminSaveBtn');
  const adminDeleteBtn = document.getElementById('adminDeleteBtn');
  const saveProgress = document.getElementById('saveProgress');
  const linesCount = document.getElementById('linesCount');

  const userDateInput = document.getElementById('userDate');
  const userLinesTextarea = document.getElementById('userLines');
  const userMatchBtn = document.getElementById('userMatchBtn');
  const resultPre = document.getElementById('resultPre');

  const copyAllBtn = document.getElementById('copyAllBtn');
  const exportBtn = document.getElementById('exportBtn');
  const printBtn = document.getElementById('printBtn');

  const userFileInput = document.getElementById('userFileInput');

  // Tabs switch
  function showAdmin(show) {
    if (show) {
      adminPanel.classList.remove('hidden');
      userPanel.classList.add('hidden');
      tabAdmin.classList.add('active');
      tabUser.classList.remove('active');
    } else {
      adminPanel.classList.add('hidden');
      userPanel.classList.remove('hidden');
      tabAdmin.classList.remove('active');
      tabUser.classList.add('active');
    }
  }

  tabAdmin.addEventListener('click', () => showAdmin(true));
  tabUser.addEventListener('click', () => showAdmin(false));
  showAdmin(false);

  // Auth check for admin email
  auth.onAuthStateChanged(user => {
    if (user) {
      if (user.email.toLowerCase() === "mateen2771@gmail.com") {
        loginSection.classList.add('hidden');
        adminControls.classList.remove('hidden');
        adminInfo.textContent = `Logged in as: ${user.email}`;
        loginStatus.textContent = '';
      } else {
        auth.signOut();
        loginStatus.textContent = '‚ùå You are not authorized as admin.';
      }
    } else {
      loginSection.classList.remove('hidden');
      adminControls.classList.add('hidden');
      adminInfo.textContent = '';
      loginStatus.textContent = '';
    }
  });

  // Login button
  loginBtn.addEventListener('click', () => {
    const email = adminEmailInput.value.trim();
    const password = adminPasswordInput.value.trim();
    if (!email || !password) {
      loginStatus.textContent = 'Enter email and password.';
      return;
    }
    loginStatus.textContent = 'Logging in...';
    auth.signInWithEmailAndPassword(email, password)
      .catch(err => {
        loginStatus.textContent = 'Login failed: ' + err.message;
      });
  });

  // Logout
  logoutBtn.addEventListener('click', () => {
    auth.signOut();
  });

  // Handle admin file import - read lines from file and append into textarea
  fileInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    if (!file.name.toLowerCase().endsWith('.txt')) {
      alert('Please select a .txt file');
      return;
    }
    const reader = new FileReader();
    reader.onload = () => {
      const importedText = reader.result.replace(/\r\n/g, '\n'); // normalize new lines
      if(adminLinesTextarea.value.trim()) {
        adminLinesTextarea.value += '\n' + importedText;
      } else {
        adminLinesTextarea.value = importedText;
      }
      saveProgress.textContent = `Imported ${importedText.split('\n').length} lines from file`;
    };
    reader.readAsText(file);
  });

  // When admin selects date, load all lines for that date and show count
  adminDateInput.addEventListener('change', async () => {
    const date = adminDateInput.value;
    adminLinesTextarea.value = '';
    saveProgress.textContent = '';
    linesCount.textContent = 'Lines saved: 0';
    if (!date) return;

    try {
      const chunksSnapshot = await db.collection('lines').doc(date).collection('chunks').get();
      if (chunksSnapshot.empty) {
        linesCount.textContent = 'Lines saved: 0';
        return;
      }

      let allLines = [];
      chunksSnapshot.forEach(doc => {
        const data = doc.data();
        if (data.lines && Array.isArray(data.lines)) {
          allLines = allLines.concat(data.lines);
        }
      });

      linesCount.textContent = `Lines saved: ${allLines.length}`;
      adminLinesTextarea.value = allLines.join('\n');

    } catch (e) {
      linesCount.textContent = 'Error loading lines.';
      console.error(e);
    }
  });

  // Save admin lines with append logic: overwrite full data with updated textarea content, chunked
  adminSaveBtn.addEventListener('click', async () => {
    const date = adminDateInput.value;
    const linesRaw = adminLinesTextarea.value.trim();
    if (!date) {
      saveProgress.textContent = 'Select a date.';
      return;
    }
    if (!linesRaw) {
      saveProgress.textContent = 'Add at least one line.';
      return;
    }
    const lines = linesRaw.split('\n').map(l => l.trim()).filter(l => l);
    if (lines.length === 0) {
      saveProgress.textContent = 'Add valid lines.';
      return;
    }

    saveProgress.textContent = 'Saving...';

    try {
      // Delete old chunks for this date first to replace all lines (append meaning whole new content)
      const chunksSnapshot = await db.collection('lines').doc(date).collection('chunks').get();
      const batchDelete = db.batch();
      chunksSnapshot.forEach(doc => {
        batchDelete.delete(doc.ref);
      });
      await batchDelete.commit();

      // Now split new lines into chunks of 500
      const chunkSize = 500;
      const chunks = [];
      for (let i = 0; i < lines.length; i += chunkSize) {
        chunks.push(lines.slice(i, i + chunkSize));
      }

      // Save each chunk as a document
      const batch = db.batch();
      chunks.forEach((chunkLines, idx) => {
        const docRef = db.collection('lines').doc(date).collection('chunks').doc('chunk' + idx);
        batch.set(docRef, { lines: chunkLines });
      });
      await batch.commit();

      saveProgress.textContent = `Saved ${lines.length} lines in ${chunks.length} chunks for date ${date}.`;
      linesCount.textContent = `Lines saved: ${lines.length}`;

    } catch (e) {
      saveProgress.textContent = 'Error saving data.';
      console.error(e);
    }
  });

  // Delete all data for selected date
  adminDeleteBtn.addEventListener('click', async () => {
    const date = adminDateInput.value;
    if (!date) {
      alert('Select a date first.');
      return;
    }
    if (!confirm(`Delete all data for date ${date}? This cannot be undone.`)) {
      return;
    }
    try {
      const chunksSnapshot = await db.collection('lines').doc(date).collection('chunks').get();
      if (chunksSnapshot.empty) {
        alert('No data to delete for this date.');
        return;
      }
      const batch = db.batch();
      chunksSnapshot.forEach(doc => {
        batch.delete(doc.ref);
      });
      await batch.commit();

      adminLinesTextarea.value = '';
      linesCount.textContent = 'Lines saved: 0';
      saveProgress.textContent = 'Deleted all data for ' + date;
    } catch (e) {
      alert('Error deleting data.');
      console.error(e);
    }
  });

  // USER PANEL

  // Import user lines from file into textarea
  userFileInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    if (!file.name.toLowerCase().endsWith('.txt')) {
      alert('Please select a .txt file');
      return;
    }
    const reader = new FileReader();
    reader.onload = () => {
      const importedText = reader.result.replace(/\r\n/g, '\n');
      if(userLinesTextarea.value.trim()) {
        userLinesTextarea.value += '\n' + importedText;
      } else {
        userLinesTextarea.value = importedText;
      }
    };
    reader.readAsText(file);
  });

  // Show / hide copy/export/print buttons
  function toggleResultButtons(show) {
    if (show) {
      copyAllBtn.classList.remove('hidden');
      exportBtn.classList.remove('hidden');
      printBtn.classList.remove('hidden');
    } else {
      copyAllBtn.classList.add('hidden');
      exportBtn.classList.add('hidden');
      printBtn.classList.add('hidden');
    }
  }

  // User match button
  userMatchBtn.addEventListener('click', async () => {
    const date = userDateInput.value;
    const linesRaw = userLinesTextarea.value.trim();

    resultPre.textContent = '';
    toggleResultButtons(false);

    if (!date) {
      resultPre.textContent = '‚ö†Ô∏è Select a date.';
      return;
    }
    if (!linesRaw) {
      resultPre.textContent = '‚ö†Ô∏è Enter your lines.';
      return;
    }

    const userLines = linesRaw.split('\n').map(l => l.trim()).filter(l => l);
    if (userLines.length === 0) {
      resultPre.textContent = '‚ö†Ô∏è Enter at least one valid line.';
      return;
    }

    resultPre.textContent = '‚è≥ Loading data... Please wait.';
    try {
      const chunksSnapshot = await db.collection('lines').doc(date).collection('chunks').get();
      if (chunksSnapshot.empty) {
        resultPre.textContent = '‚ùå No data found for that date.';
        return;
      }

      let allAdminLines = [];
      chunksSnapshot.forEach(doc => {
        const data = doc.data();
        if (data.lines && Array.isArray(data.lines)) {
          allAdminLines = allAdminLines.concat(data.lines);
        }
      });

      const adminLinesSet = new Set(allAdminLines);
      const matched = userLines.filter(line => adminLinesSet.has(line));

      if (matched.length === 0) {
        resultPre.textContent = '‚ÑπÔ∏è No matched lines found.';
        return;
      }

      resultPre.textContent = matched.join('\n');
      toggleResultButtons(true);
    } catch (e) {
      console.error(e);
      resultPre.textContent = '‚ùå Error loading data.';
    }
  });

  // Copy all matched lines
  copyAllBtn.addEventListener('click', () => {
    const text = resultPre.textContent.trim();
    if (!text) {
      alert('No matched lines to copy.');
      return;
    }
    navigator.clipboard.writeText(text).then(() => {
      alert('‚úÖ All matched lines copied to clipboard!');
    }).catch(() => {
      alert('‚ùå Copy failed. Try manually.');
    });
  });

  // Export matched lines to Excel
  exportBtn.addEventListener('click', () => {
    const text = resultPre.textContent.trim();
    if (!text) {
      alert('No matched lines to export.');
      return;
    }
    const lines = text.split('\n').map(l => [l]); // array of arrays for XLSX

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(lines);
    XLSX.utils.book_append_sheet(wb, ws, 'MatchedLines');
    XLSX.writeFile(wb, 'matched_lines.xlsx');
  });

  // Print matched lines
  printBtn.addEventListener('click', () => {
    const text = resultPre.textContent.trim();
    if (!text) {
      alert('No matched lines to print.');
      return;
    }
    const newWin = window.open('', '_blank');
    newWin.document.write('<pre style="font-size:16px; padding:15px;">' + text.replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</pre>');
    newWin.document.close();
    newWin.focus();
    newWin.print();
  });
</script>

</body>
</html>
