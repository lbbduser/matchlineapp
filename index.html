<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Match Line System with Append & Count</title>
<style>
  body {
    margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #111; color: #eee; min-height: 100vh; display: flex; align-items: center; justify-content: center;
    padding: 15px;
  }
  .container {
    max-width: 600px; width: 100%;
    background: #1a1a1a; border-radius: 12px;
    padding: 20px 25px; box-shadow: 0 0 30px #00ffccaa;
  }
  h2 {
    text-align: center; color: #00ffcc; margin-bottom: 25px;
  }
  input, textarea, button, select {
    width: 100%; margin-bottom: 15px; border-radius: 8px;
    border: none; padding: 10px 12px; font-size: 16px;
    box-sizing: border-box;
  }
  button {
    background: #00ffcc; color: #000; font-weight: 700;
    cursor: pointer; transition: background 0.3s ease;
  }
  button:hover {
    background: #00ccaaff;
  }
  .tabs {
    display: flex; margin-bottom: 30px;
  }
  .tabs button {
    flex: 1; padding: 12px 0; background: #222;
    color: #eee; font-weight: 600; border-radius: 0;
    border-bottom: 3px solid transparent; cursor: pointer;
    transition: background 0.3s ease, border-color 0.3s ease;
  }
  .tabs button.active {
    background: #000;
    border-color: #00ffcc;
  }
  .hidden {
    display: none !important;
  }
  #result {
    margin-top: 20px;
  }
  .match-line {
    background: #222; border-radius: 8px; padding: 10px 15px;
    margin-bottom: 8px; display: flex; justify-content: space-between;
    align-items: center; cursor: pointer;
    transition: background 0.3s ease;
  }
  .match-line:hover {
    background: #00ffcc22;
  }
  .copy-btn {
    background: #00cc99; border: none; color: #000; padding: 4px 10px;
    border-radius: 5px; cursor: pointer; font-weight: 600;
    font-size: 14px;
    user-select: none;
  }
  #adminInfo {
    color: #0f0; font-weight: 600; margin-bottom: 15px;
  }
  #loginStatus {
    color: #f44; font-weight: 600; margin-bottom: 15px;
  }
  #logoutBtn {
    background: #f44 !important;
    margin-bottom: 15px;
  }
  #fileInputLabel, #userFileInputLabel {
    display: block;
    background: #008080aa;
    color: white;
    font-weight: 700;
    text-align: center;
    padding: 12px;
    border-radius: 8px;
    cursor: pointer;
    margin-bottom: 15px;
  }
  #fileInput, #userFileInput {
    display: none;
  }
  #saveProgress {
    font-weight: 600;
    margin-bottom: 15px;
    color: #0ff;
  }
  #linesCount {
    color: #0ff; font-weight: 600; margin-bottom: 10px;
  }
  #allMatchesText {
    resize: none;
  }
  #adminButtonsRow {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
  }
  #adminButtonsRow button {
    flex: 1;
  }
</style>
</head>
<body>

<div class="container">
  <h2>üîê Match Line System with Append & Count</h2>

  <div class="tabs">
    <button id="tabAdmin">Admin</button>
    <button id="tabUser" class="active">User</button>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel" class="hidden">
    <div id="loginSection">
      <input type="email" id="adminEmail" placeholder="Admin Email" autocomplete="off" />
      <input type="password" id="adminPassword" placeholder="Password" autocomplete="off" />
      <button id="loginBtn">Login</button>
      <p id="loginStatus"></p>
    </div>

    <div id="adminControls" class="hidden">
      <p id="adminInfo">Logged in as Admin</p>
      <button id="logoutBtn">Logout</button>

      <input type="date" id="adminDate" />
      <p id="linesCount">Lines saved: 0</p>

      <div id="adminButtonsRow">
        <button id="adminSaveBtn">Save Lines (Append)</button>
        <button id="adminDeleteBtn" style="background:#f44; color:#fff;">Delete Date Data</button>
      </div>

      <textarea id="adminLines" rows="8" placeholder="Paste new lines here to append (one per line)"></textarea>

      <label id="fileInputLabel" for="fileInput">üìÇ Import lines from file (.txt)</label>
      <input type="file" id="fileInput" accept=".txt" />

      <p id="saveProgress"></p>
    </div>
  </div>

  <!-- User Panel -->
  <div id="userPanel">
    <input type="date" id="userDate" />

    <label id="userFileInputLabel" for="userFileInput">üìÇ Import lines from file (.txt)</label>
    <input type="file" id="userFileInput" accept=".txt" />

    <textarea id="userLines" rows="6" placeholder="Enter your lines (one per line)"></textarea>
    <button id="userMatchBtn">Show Results</button>

    <button id="exportBtn" class="hidden" style="margin-top:15px;">Export Matched to Excel</button>
    <button id="printBtn" class="hidden" style="margin-top:10px;">Print Matched Results</button>

    <div id="result"></div>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- SheetJS for Excel export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCasjbGx7JBgbnZbGLkMx0RDb3OFRR4I_o",
    authDomain: "matchlineapp.firebaseapp.com",
    projectId: "matchlineapp",
    storageBucket: "matchlineapp.firebasestorage.app",
    messagingSenderId: "1053732074460",
    appId: "1:1053732074460:web:cde960ac63d4bd32151519"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // UI Elements
  const tabAdmin = document.getElementById('tabAdmin');
  const tabUser = document.getElementById('tabUser');
  const adminPanel = document.getElementById('adminPanel');
  const userPanel = document.getElementById('userPanel');

  const loginSection = document.getElementById('loginSection');
  const adminControls = document.getElementById('adminControls');
  const adminEmailInput = document.getElementById('adminEmail');
  const adminPasswordInput = document.getElementById('adminPassword');
  const loginBtn = document.getElementById('loginBtn');
  const loginStatus = document.getElementById('loginStatus');
  const logoutBtn = document.getElementById('logoutBtn');
  const adminInfo = document.getElementById('adminInfo');

  const adminDateInput = document.getElementById('adminDate');
  const adminLinesTextarea = document.getElementById('adminLines');
  const fileInput = document.getElementById('fileInput');
  const adminSaveBtn = document.getElementById('adminSaveBtn');
  const adminDeleteBtn = document.getElementById('adminDeleteBtn');
  const saveProgress = document.getElementById('saveProgress');
  const linesCount = document.getElementById('linesCount');

  const userDateInput = document.getElementById('userDate');
  const userLinesTextarea = document.getElementById('userLines');
  const userMatchBtn = document.getElementById('userMatchBtn');
  const resultDiv = document.getElementById('result');

  const exportBtn = document.getElementById('exportBtn');
  const printBtn = document.getElementById('printBtn');

  const userFileInput = document.getElementById('userFileInput');

  // Tabs switch with forced logout when leaving admin panel
  function showAdmin(show) {
    if (show) {
      adminPanel.classList.remove('hidden');
      userPanel.classList.add('hidden');
      tabAdmin.classList.add('active');
      tabUser.classList.remove('active');
    } else {
      adminPanel.classList.add('hidden');
      userPanel.classList.remove('hidden');
      tabAdmin.classList.remove('active');
      tabUser.classList.add('active');
      // Force logout admin when switching to user tab
      auth.signOut();
    }
  }

  tabAdmin.addEventListener('click', () => showAdmin(true));
  tabUser.addEventListener('click', () => showAdmin(false));
  showAdmin(false);

  // Auth check for admin email
  auth.onAuthStateChanged(user => {
    if (user) {
      if (user.email.toLowerCase() === "mateen2771@gmail.com") {
        loginSection.classList.add('hidden');
        adminControls.classList.remove('hidden');
        adminInfo.textContent = `Logged in as: ${user.email}`;
        loginStatus.textContent = '';
      } else {
        auth.signOut();
        loginStatus.textContent = '‚ùå You are not authorized as admin.';
      }
    } else {
      loginSection.classList.remove('hidden');
      adminControls.classList.add('hidden');
      adminInfo.textContent = '';
      loginStatus.textContent = '';
    }
  });

  // Login button
  loginBtn.addEventListener('click', () => {
    const email = adminEmailInput.value.trim();
    const password = adminPasswordInput.value.trim();
    if (!email || !password) {
      loginStatus.textContent = 'Enter email and password.';
      return;
    }
    loginStatus.textContent = 'Logging in...';
    auth.signInWithEmailAndPassword(email, password)
      .catch(err => {
        loginStatus.textContent = 'Login failed: ' + err.message;
      });
  });

  // Logout
  logoutBtn.addEventListener('click', () => {
    auth.signOut();
  });

  // Handle admin file import - read lines from file and append into textarea
  fileInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    if (!file.name.toLowerCase().endsWith('.txt')) {
      alert('Please select a .txt file');
      return;
    }
    const reader = new FileReader();
    reader.onload = () => {
      const importedText = reader.result.replace(/\r\n/g, '\n'); // normalize new lines
      if(adminLinesTextarea.value.trim()) {
        adminLinesTextarea.value += '\n' + importedText;
      } else {
        adminLinesTextarea.value = importedText;
      }
      saveProgress.textContent = `Imported ${importedText.split('\n').length} lines from file`;
    };
    reader.readAsText(file);
  });

  // When admin selects date, load all lines for that date and show count
  adminDateInput.addEventListener('change', async () => {
    const date = adminDateInput.value;
    adminLinesTextarea.value = '';
    saveProgress.textContent = '';
    linesCount.textContent = 'Lines saved: 0';
    if (!date) return;

    try {
      const chunksSnapshot = await db.collection('lines').doc(date).collection('chunks').get();
      if (chunksSnapshot.empty) {
        linesCount.textContent = 'Lines saved: 0';
        return;
      }

      let allLines = [];
      chunksSnapshot.forEach(doc => {
        const data = doc.data();
        if (data.lines && Array.isArray(data.lines)) {
          allLines = allLines.concat(data.lines);
        }
      });

      linesCount.textContent = `Lines saved: ${allLines.length}`;
      adminLinesTextarea.value = allLines.join('\n');

    } catch (e) {
      linesCount.textContent = 'Error loading lines.';
      console.error(e);
    }
  });

  // Save admin lines with append logic: overwrite full data with updated textarea content, chunked
  adminSaveBtn.addEventListener('click', async () => {
    const date = adminDateInput.value;
    const linesRaw = adminLinesTextarea.value.trim();
    if (!date) {
      saveProgress.textContent = 'Select a date.';
      return;
    }
    if (!linesRaw) {
      saveProgress.textContent = 'Add at least one line.';
      return;
    }
    const lines = linesRaw.split('\n').map(l => l.trim()).filter(l => l);
    if (lines.length === 0) {
      saveProgress.textContent = 'Add at least one valid line.';
      return;
    }

    saveProgress.textContent = 'Saving... 10';
    let countdown = 10;
    let saveFinished = false;

    const countdownInterval = setInterval(() => {
      countdown--;
      if (countdown <= 0 || saveFinished) {
        clearInterval(countdownInterval);
        if (!saveFinished) {
          saveProgress.textContent = 'Saving...';
        }
      } else {
        saveProgress.textContent = `Saving... ${countdown}`;
      }
    }, 1000);

    try {
      // Delete all old chunks before saving updated lines (overwrite)
      const oldChunksSnapshot = await db.collection('lines').doc(date).collection('chunks').get();
      const batchDelete = db.batch();
      oldChunksSnapshot.forEach(doc => batchDelete.delete(doc.ref));
      await batchDelete.commit();

      // Save new lines in chunks
      const chunkSize = 1000;
      const chunks = [];
      for (let i = 0; i < lines.length; i += chunkSize) {
        chunks.push(lines.slice(i, i + chunkSize));
      }

      const batchSave = db.batch();
      chunks.forEach((chunkLines, idx) => {
        const chunkDoc = db.collection('lines').doc(date).collection('chunks').doc(`chunk_${idx + 1}`);
        batchSave.set(chunkDoc, { lines: chunkLines });
      });
      await batchSave.commit();

      saveFinished = true; // stop countdown early
      clearInterval(countdownInterval);
      saveProgress.textContent = '';
      linesCount.textContent = `Lines saved: ${lines.length}`;

      alert(`‚úÖ Saved ${lines.length} lines for date ${date}!`);

      fileInput.value = '';

    } catch (e) {
      clearInterval(countdownInterval);
      saveProgress.textContent = '‚ùå Error saving. Try again.';
      console.error(e);
    }
  });

  // Delete all chunks under a date
  adminDeleteBtn.addEventListener('click', async () => {
    const date = adminDateInput.value;
    if (!date) {
      alert('Select a date to delete.');
      return;
    }
    if (!confirm(`Are you sure you want to DELETE all data for date ${date}? This action cannot be undone.`)) return;

    try {
      // Get all chunk docs
      const chunksSnapshot = await db.collection('lines').doc(date).collection('chunks').get();
      if (chunksSnapshot.empty) {
        alert('No data found for this date to delete.');
        return;
      }

      // Batch delete all chunks
      const batch = db.batch();
      chunksSnapshot.forEach(doc => {
        batch.delete(doc.ref);
      });

      await batch.commit();

      alert(`‚úÖ All data for date ${date} deleted successfully!`);

      saveProgress.textContent = `Deleted all data for ${date}. You can now import new files for this date.`;
      adminLinesTextarea.value = '';
      linesCount.textContent = 'Lines saved: 0';
      fileInput.value = '';

    } catch (e) {
      alert('‚ùå Error deleting data.');
      console.error(e);
    }
  });

  // User show matches, reading all chunks
  userMatchBtn.addEventListener('click', async () => {
    const date = userDateInput.value;
    const linesRaw = userLinesTextarea.value.trim();
    if (!date) {
      resultDiv.innerHTML = '<p>Select a date.</p>';
      exportBtn.classList.add('hidden');
      printBtn.classList.add('hidden');
      return;
    }
    if (!linesRaw) {
      resultDiv.innerHTML = '<p>Enter your lines.</p>';
      exportBtn.classList.add('hidden');
      printBtn.classList.add('hidden');
      return;
    }
    const userLines = linesRaw.split('\n').map(l => l.trim()).filter(l => l);
    if (userLines.length === 0) {
      resultDiv.innerHTML = '<p>Enter at least one valid line.</p>';
      exportBtn.classList.add('hidden');
      printBtn.classList.add('hidden');
      return;
    }
    resultDiv.innerHTML = 'Loading...';
    try {
      const chunksSnapshot = await db.collection('lines').doc(date).collection('chunks').get();
      if (chunksSnapshot.empty) {
        resultDiv.innerHTML = '<p>No data for that date.</p>';
        exportBtn.classList.add('hidden');
        printBtn.classList.add('hidden');
        return;
      }

      let allAdminLines = [];
      chunksSnapshot.forEach(doc => {
        const data = doc.data();
        if (data.lines && Array.isArray(data.lines)) {
          allAdminLines = allAdminLines.concat(data.lines);
        }
      });

      // Find matched lines
      const matched = userLines.filter(line => allAdminLines.includes(line));

      if (matched.length === 0) {
        resultDiv.innerHTML = '<p>No matched lines found.</p>';
        exportBtn.classList.add('hidden');
        printBtn.classList.add('hidden');
        return;
      }

      // Show matched lines count + copy all button + list lines
      const matchCount = matched.length;
      let html = `<p>Matched lines: <strong>${matchCount}</strong></p>`;
      html += `<button id="copyAllBtn" class="copy-btn" style="margin-bottom:10px;">Copy All Matched Lines</button>`;
      html += `<div>`;
      matched.forEach(line => {
        html += `<div class="match-line">${line}</div>`;
      });
      html += `</div>`;

      resultDiv.innerHTML = html;
      exportBtn.classList.remove('hidden');
      printBtn.classList.remove('hidden');

      // Attach copy all click event
      document.getElementById('copyAllBtn').addEventListener('click', () => {
        navigator.clipboard.writeText(matched.join('\n')).then(() => {
          alert('All matched lines copied to clipboard!');
        }).catch(() => {
          alert('Copy failed. Try manually.');
        });
      });

    } catch (e) {
      resultDiv.innerHTML = '<p>Error loading data.</p>';
      exportBtn.classList.add('hidden');
      printBtn.classList.add('hidden');
      console.error(e);
    }
  });

  // User file import (append)
  userFileInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    if (!file.name.toLowerCase().endsWith('.txt')) {
      alert('Please select a .txt file');
      return;
    }
    const reader = new FileReader();
    reader.onload = () => {
      const importedText = reader.result.replace(/\r\n/g, '\n'); // normalize new lines
      if(userLinesTextarea.value.trim()) {
        userLinesTextarea.value += '\n' + importedText;
      } else {
        userLinesTextarea.value = importedText;
      }
    };
    reader.readAsText(file);
  });

  // Export matched results to Excel
  exportBtn.addEventListener('click', () => {
    const matchedLines = [];
    const matchDivs = document.querySelectorAll('#result .match-line');
    matchDivs.forEach(div => {
      matchedLines.push(div.textContent);
    });
    if (matchedLines.length === 0) {
      alert('No matches to export.');
      return;
    }
    const worksheet = XLSX.utils.aoa_to_sheet([['Matched Lines'], ...matchedLines.map(m => [m])]);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Matches");
    XLSX.writeFile(workbook, "matched_lines.xlsx");
  });

  // Print matched results
  printBtn.addEventListener('click', () => {
    const matchDivs = document.querySelectorAll('#result .match-line');
    if (matchDivs.length === 0) {
      alert('No matches to print.');
      return;
    }
    let printContent = '';
    matchDivs.forEach(div => {
      printContent += div.textContent + '\n';
    });
    const printWindow = window.open('', '', 'height=600,width=400');
    printWindow.document.write('<html><head><title>Print Matches</title>');
    printWindow.document.write('<style>body{font-family:sans-serif; padding:10px;} pre {font-family: monospace; white-space: pre-wrap;}</style>');
    printWindow.document.write('</head><body><pre>' + printContent + '</pre></body></html>');
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
    printWindow.close();
  });
</script>

</body>
</html>
